<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newton's Chromatic MIDI Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
        }

        #control-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 2px solid #333;
            padding: 15px;
            z-index: 1000;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        #control-panel h1 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: #fff;
        }

        .lane-control {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid #444;
        }

        .lane-control label {
            font-weight: 600;
            font-size: 13px;
            color: #aaa;
        }

        .lane-control select {
            padding: 6px 10px;
            background: #222;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 13px;
            min-width: 200px;
            cursor: pointer;
        }

        .lane-control select:hover {
            border-color: #777;
        }

        .note-count {
            padding: 4px 10px;
            background: #333;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }

        .note-count.active {
            background: #0a0;
            color: #000;
        }

        #canvas-container {
            margin-top: 80px;
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        .lane {
            flex: 1;
            position: relative;
            border-bottom: 2px solid #333;
        }

        .lane:last-child {
            border-bottom: none;
        }

        .lane canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .lane-label {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 32px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            letter-spacing: 2px;
        }

        #no-midi-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            font-size: 18px;
            line-height: 1.8;
            max-width: 600px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid #333;
        }

        #no-midi-message h2 {
            color: #999;
            margin-bottom: 20px;
            font-size: 24px;
        }

        #no-midi-message.hidden {
            display: none;
        }

        .info-button {
            padding: 6px 12px;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .info-button:hover {
            background: #444;
            border-color: #777;
        }

        #info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            overflow-y: auto;
            padding: 40px 20px;
        }

        #info-modal.visible {
            display: block;
        }

        .modal-content {
            max-width: 800px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 40px;
            border: 1px solid #333;
        }

        .modal-content h2 {
            margin-top: 30px;
            margin-bottom: 15px;
            color: #fff;
            font-size: 24px;
        }

        .modal-content h2:first-child {
            margin-top: 0;
        }

        .modal-content p, .modal-content li {
            line-height: 1.8;
            color: #ccc;
            margin-bottom: 10px;
        }

        .modal-content ul {
            margin-left: 20px;
            margin-bottom: 20px;
        }

        .modal-content code {
            background: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #0f0;
        }

        .close-button {
            float: right;
            font-size: 32px;
            font-weight: 300;
            color: #666;
            cursor: pointer;
            line-height: 1;
            padding: 0 10px;
        }

        .close-button:hover {
            color: #fff;
        }

        .color-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .color-swatch {
            width: 30px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #555;
        }
    </style>
</head>
<body>
    <div id="control-panel">
        <h1>Newton's Chromatic MIDI Visualizer</h1>
        
        <div class="lane-control">
            <label>Lane 1:</label>
            <select id="device-select-0">
                <option value="">Select MIDI Device...</option>
            </select>
            <span class="note-count" id="note-count-0">0 notes</span>
        </div>

        <div class="lane-control">
            <label>Lane 2:</label>
            <select id="device-select-1">
                <option value="">Select MIDI Device...</option>
            </select>
            <span class="note-count" id="note-count-1">0 notes</span>
        </div>

        <div class="lane-control">
            <label>Lane 3:</label>
            <select id="device-select-2">
                <option value="">Select MIDI Device...</option>
            </select>
            <span class="note-count" id="note-count-2">0 notes</span>
        </div>

        <button class="info-button" onclick="toggleInfo()">ℹ️ Info</button>
    </div>

    <div id="canvas-container">
        <div class="lane">
            <canvas id="canvas-0"></canvas>
            <div class="lane-label">LANE 1</div>
        </div>
        <div class="lane">
            <canvas id="canvas-1"></canvas>
            <div class="lane-label">LANE 2</div>
        </div>
        <div class="lane">
            <canvas id="canvas-2"></canvas>
            <div class="lane-label">LANE 3</div>
        </div>
    </div>

    <div id="no-midi-message">
        <h2>No MIDI Devices Detected</h2>
        <p>Please connect a MIDI controller or set up an IAC Driver for Logic Pro.</p>
        <p style="margin-top: 20px; font-size: 14px;">
            <strong>Using Chrome, Edge, or Opera?</strong> These browsers support Web MIDI.<br>
            Safari has limited support.
        </p>
    </div>

    <div id="info-modal">
        <div class="modal-content">
            <span class="close-button" onclick="toggleInfo()">&times;</span>
            <h2>About This Visualizer</h2>
            <p>This is a real-time MIDI visualizer that uses Isaac Newton's color model to map musical pitches to colors across the visible light spectrum.</p>

            <h2>Color Mapping</h2>
            <div class="color-legend">
                <div class="color-item"><div class="color-swatch" style="background: #680082;"></div>C - Violet</div>
                <div class="color-item"><div class="color-swatch" style="background: #4C00FF;"></div>C# - Indigo</div>
                <div class="color-item"><div class="color-swatch" style="background: #003DFF;"></div>D - Blue</div>
                <div class="color-item"><div class="color-swatch" style="background: #00EBFF;"></div>D# - Cyan</div>
                <div class="color-item"><div class="color-swatch" style="background: #2CFF00;"></div>E - Green</div>
                <div class="color-item"><div class="color-swatch" style="background: #99FF00;"></div>F - Yellow-Green</div>
                <div class="color-item"><div class="color-swatch" style="background: #FFF700;"></div>F# - Yellow</div>
                <div class="color-item"><div class="color-swatch" style="background: #FF8100;"></div>G - Orange</div>
                <div class="color-item"><div class="color-swatch" style="background: #FF0C00;"></div>G# - Red-Orange</div>
                <div class="color-item"><div class="color-swatch" style="background: #FF0000;"></div>A - Red</div>
                <div class="color-item"><div class="color-swatch" style="background: #F80000;"></div>A# - Red</div>
                <div class="color-item"><div class="color-swatch" style="background: #8D0000;"></div>B - Dark Red</div>
            </div>

            <h2>How to Use</h2>
            <ul>
                <li><strong>Connect MIDI Device:</strong> Plug in your MIDI keyboard or controller via USB</li>
                <li><strong>Select Device:</strong> Choose your device from the dropdown for each lane</li>
                <li><strong>Play Music:</strong> Notes will appear as colored circles</li>
                <li><strong>Multiple Lanes:</strong> Assign different MIDI sources to visualize multiple parts simultaneously</li>
            </ul>

            <h2>Logic Pro Integration</h2>
            <ul>
                <li>Enable IAC Driver in <code>Audio MIDI Setup</code></li>
                <li>In Logic Pro, set track output to IAC bus</li>
                <li>Select the IAC bus in the visualizer</li>
                <li>Play your Logic project to see real-time visualization</li>
            </ul>

            <h2>Visual Properties</h2>
            <ul>
                <li><strong>Horizontal Position:</strong> Pitch (left = low, right = high)</li>
                <li><strong>Circle Size:</strong> Velocity (how hard the note was played)</li>
                <li><strong>Color:</strong> Pitch class + octave using Newton's spectrum (380-750nm)</li>
                <li><strong>Fade:</strong> Notes fade out after release over 1 second</li>
            </ul>

            <h2>Browser Support</h2>
            <p>This visualizer requires Web MIDI API support:</p>
            <ul>
                <li>✅ Chrome / Chromium (recommended)</li>
                <li>✅ Edge</li>
                <li>✅ Opera</li>
                <li>⚠️ Safari (limited support)</li>
            </ul>

            <h2>Troubleshooting</h2>
            <ul>
                <li><strong>No devices showing?</strong> Make sure your MIDI device is connected and that you've allowed MIDI access in your browser</li>
                <li><strong>Notes not appearing?</strong> Check that the correct device is selected for each lane</li>
                <li><strong>IAC Driver not showing?</strong> Ensure it's enabled in Audio MIDI Setup and Logic Pro is running</li>
            </ul>
        </div>
    </div>

    <script>
        // ============================================================================
        // COLOR ENGINE - Newton's Chromatic Mapping (C=Violet)
        // ============================================================================
        
        const PITCH_CLASSES = {
            0: { name: 'C', colorName: 'Violet', minWavelength: 380, maxWavelength: 410 },
            1: { name: 'C#', colorName: 'Indigo-Violet', minWavelength: 410, maxWavelength: 440 },
            2: { name: 'D', colorName: 'Indigo', minWavelength: 440, maxWavelength: 470 },
            3: { name: 'D#', colorName: 'Blue', minWavelength: 470, maxWavelength: 510 },
            4: { name: 'E', colorName: 'Blue-Cyan', minWavelength: 510, maxWavelength: 540 },
            5: { name: 'F', colorName: 'Cyan-Green', minWavelength: 540, maxWavelength: 570 },
            6: { name: 'F#', colorName: 'Green', minWavelength: 570, maxWavelength: 600 },
            7: { name: 'G', colorName: 'Yellow-Green', minWavelength: 600, maxWavelength: 630 },
            8: { name: 'G#', colorName: 'Yellow', minWavelength: 630, maxWavelength: 660 },
            9: { name: 'A', colorName: 'Orange', minWavelength: 660, maxWavelength: 690 },
            10: { name: 'A#', colorName: 'Red-Orange', minWavelength: 690, maxWavelength: 720 },
            11: { name: 'B', colorName: 'Red', minWavelength: 720, maxWavelength: 750 }
        };

        class ColorEngine {
            constructor() {
                this.colorTable = new Map();
                this.generateColorTable();
            }

            noteToWavelength(midiNote) {
                const pitchClass = midiNote % 12;
                const octave = Math.floor(midiNote / 12) - 1;
                
                const pitchInfo = PITCH_CLASSES[pitchClass];
                const { minWavelength, maxWavelength } = pitchInfo;
                
                const colorOctave = Math.max(0, Math.min(10, octave));
                
                return minWavelength + (colorOctave / 10) * (maxWavelength - minWavelength);
            }

            wavelengthToRGB(wavelength) {
                let r = 0, g = 0, b = 0;

                if (wavelength < 380 || wavelength > 750) {
                    return { r: 0, g: 0, b: 0, hex: '#000000' };
                }

                if (wavelength >= 380 && wavelength < 440) {
                    r = -(wavelength - 440) / (440 - 380);
                    g = 0.0;
                    b = 1.0;
                } else if (wavelength >= 440 && wavelength < 490) {
                    r = 0.0;
                    g = (wavelength - 440) / (490 - 440);
                    b = 1.0;
                } else if (wavelength >= 490 && wavelength < 510) {
                    r = 0.0;
                    g = 1.0;
                    b = -(wavelength - 510) / (510 - 490);
                } else if (wavelength >= 510 && wavelength < 580) {
                    r = (wavelength - 510) / (580 - 510);
                    g = 1.0;
                    b = 0.0;
                } else if (wavelength >= 580 && wavelength < 645) {
                    r = 1.0;
                    g = -(wavelength - 645) / (645 - 580);
                    b = 0.0;
                } else if (wavelength >= 645 && wavelength <= 750) {
                    r = 1.0;
                    g = 0.0;
                    b = 0.0;
                }

                let intensity = 1.0;
                if (wavelength >= 380 && wavelength < 420) {
                    intensity = 0.3 + 0.7 * (wavelength - 380) / (420 - 380);
                } else if (wavelength >= 700 && wavelength <= 750) {
                    intensity = 0.3 + 0.7 * (750 - wavelength) / (750 - 700);
                }

                const r255 = Math.round(Math.pow(r * intensity, 0.8) * 255);
                const g255 = Math.round(Math.pow(g * intensity, 0.8) * 255);
                const b255 = Math.round(Math.pow(b * intensity, 0.8) * 255);

                const hex = `#${r255.toString(16).padStart(2, '0')}${g255.toString(16).padStart(2, '0')}${b255.toString(16).padStart(2, '0')}`.toUpperCase();

                return { r: r255, g: g255, b: b255, hex };
            }

            getColor(midiNote) {
                return this.colorTable.get(midiNote) || { r: 0, g: 0, b: 0, hex: '#000000' };
            }

            getNoteName(midiNote) {
                const pitchClass = midiNote % 12;
                const octave = Math.floor(midiNote / 12) - 1;
                return `${PITCH_CLASSES[pitchClass].name}${octave}`;
            }

            generateColorTable() {
                for (let midiNote = 0; midiNote <= 127; midiNote++) {
                    const wavelength = this.noteToWavelength(midiNote);
                    const color = this.wavelengthToRGB(wavelength);
                    this.colorTable.set(midiNote, color);
                }
                console.log('✓ Color lookup table generated: 128 entries');
            }
        }

        const colorEngine = new ColorEngine();

        // ============================================================================
        // MIDI VISUALIZER APPLICATION
        // ============================================================================

        class MIDIVisualizer {
            constructor() {
                this.midiAccess = null;
                this.lanes = [
                    { activeNotes: new Map(), connectedDevice: null, canvas: null, ctx: null },
                    { activeNotes: new Map(), connectedDevice: null, canvas: null, ctx: null },
                    { activeNotes: new Map(), connectedDevice: null, canvas: null, ctx: null }
                ];
                this.devices = [];
                this.decayTime = 1000; // milliseconds
                
                this.init();
            }

            async init() {
                // Setup canvases
                this.lanes.forEach((lane, index) => {
                    lane.canvas = document.getElementById(`canvas-${index}`);
                    lane.ctx = lane.canvas.getContext('2d');
                    this.resizeCanvas(index);
                });

                window.addEventListener('resize', () => {
                    this.lanes.forEach((_, index) => this.resizeCanvas(index));
                });

                // Request MIDI access
                if (navigator.requestMIDIAccess) {
                    try {
                        this.midiAccess = await navigator.requestMIDIAccess();
                        console.log('✓ MIDI Access granted');
                        this.updateDeviceList();
                        this.midiAccess.onstatechange = () => this.updateDeviceList();
                        this.hideNoMidiMessage();
                    } catch (err) {
                        console.error('✗ MIDI Access denied:', err);
                        alert('MIDI access denied. Please allow MIDI access in your browser.');
                    }
                } else {
                    alert('Web MIDI API not supported. Please use Chrome, Edge, or Opera.');
                }

                // Start animation loop
                this.animate();
            }

            resizeCanvas(laneIndex) {
                const canvas = this.lanes[laneIndex].canvas;
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }

            updateDeviceList() {
                this.devices = [];
                this.midiAccess.inputs.forEach(input => {
                    this.devices.push({ id: input.id, name: input.name || 'Unknown Device' });
                });

                // Update all dropdowns
                for (let i = 0; i < 3; i++) {
                    const select = document.getElementById(`device-select-${i}`);
                    const currentValue = select.value;
                    
                    select.innerHTML = '<option value="">Select MIDI Device...</option>';
                    this.devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.id;
                        option.textContent = device.name;
                        select.appendChild(option);
                    });
                    
                    select.value = currentValue;
                    select.onchange = () => this.connectDeviceToLane(select.value, i);
                }

                if (this.devices.length > 0) {
                    this.hideNoMidiMessage();
                } else {
                    this.showNoMidiMessage();
                }

                console.log('Available MIDI devices:', this.devices);
            }

            connectDeviceToLane(deviceId, laneIndex) {
                if (!this.midiAccess) return;

                // Disconnect previous device
                const currentDevice = this.lanes[laneIndex].connectedDevice;
                if (currentDevice) {
                    const input = this.midiAccess.inputs.get(currentDevice);
                    if (input) input.onmidimessage = null;
                }

                // Connect new device
                if (deviceId) {
                    const input = this.midiAccess.inputs.get(deviceId);
                    if (input) {
                        input.onmidimessage = (message) => this.handleMIDIMessage(message, laneIndex);
                        this.lanes[laneIndex].connectedDevice = deviceId;
                        console.log(`✓ Connected ${input.name} to Lane ${laneIndex + 1}`);
                    }
                } else {
                    this.lanes[laneIndex].connectedDevice = null;
                }
            }

            handleMIDIMessage(message, laneIndex) {
                const [status, note, velocity] = message.data;
                const command = status & 0xf0;

                if (command === 0x90 && velocity > 0) {
                    this.handleNoteOn(note, velocity, laneIndex);
                } else if (command === 0x80 || (command === 0x90 && velocity === 0)) {
                    this.handleNoteOff(note, laneIndex);
                }
            }

            handleNoteOn(midiNote, velocity, laneIndex) {
                const color = colorEngine.getColor(midiNote);
                const noteName = colorEngine.getNoteName(midiNote);
                
                console.log(`Lane ${laneIndex + 1}: ${noteName} ON (vel=${velocity}) ${color.hex}`);

                this.lanes[laneIndex].activeNotes.set(midiNote, {
                    midiNote,
                    velocity,
                    color,
                    startTime: performance.now(),
                    releaseTime: null
                });

                this.updateNoteCount(laneIndex);
            }

            handleNoteOff(midiNote, laneIndex) {
                const note = this.lanes[laneIndex].activeNotes.get(midiNote);
                if (note) {
                    note.releaseTime = performance.now();
                    console.log(`Lane ${laneIndex + 1}: ${colorEngine.getNoteName(midiNote)} OFF`);
                }
            }

            updateNoteCount(laneIndex) {
                const count = this.lanes[laneIndex].activeNotes.size;
                const element = document.getElementById(`note-count-${laneIndex}`);
                element.textContent = `${count} note${count !== 1 ? 's' : ''}`;
                element.classList.toggle('active', count > 0);
            }

            animate() {
                const now = performance.now();

                this.lanes.forEach((lane, laneIndex) => {
                    const ctx = lane.ctx;
                    const canvas = lane.canvas;

                    // Clear canvas
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Render active notes
                    lane.activeNotes.forEach((note, midiNote) => {
                        let opacity = 1.0;

                        // Calculate decay
                        if (note.releaseTime) {
                            const elapsed = now - note.releaseTime;
                            opacity = Math.max(0, 1 - elapsed / this.decayTime);

                            if (opacity <= 0) {
                                lane.activeNotes.delete(midiNote);
                                this.updateNoteCount(laneIndex);
                                return;
                            }
                        }

                        // Calculate position and size
                        const x = (midiNote / 127) * canvas.width;
                        const y = canvas.height / 2;
                        const radius = 20 + (note.velocity / 127) * 30;

                        // Draw note circle
                        ctx.globalAlpha = opacity;
                        ctx.fillStyle = note.color.hex;
                        ctx.beginPath();
                        ctx.arc(x, y, radius, 0, Math.PI * 2);
                        ctx.fill();

                        // Draw note name
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = '12px monospace';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        const noteName = colorEngine.getNoteName(midiNote);
                        ctx.fillText(noteName, x, y);
                    });

                    ctx.globalAlpha = 1.0;
                });

                requestAnimationFrame(() => this.animate());
            }

            showNoMidiMessage() {
                document.getElementById('no-midi-message').classList.remove('hidden');
            }

            hideNoMidiMessage() {
                document.getElementById('no-midi-message').classList.add('hidden');
            }
        }

        // Initialize visualizer
        const visualizer = new MIDIVisualizer();

        // Info modal
        function toggleInfo() {
            const modal = document.getElementById('info-modal');
            modal.classList.toggle('visible');
        }

        // Close modal when clicking outside
        document.getElementById('info-modal').addEventListener('click', (e) => {
            if (e.target.id === 'info-modal') {
                toggleInfo();
            }
        });

        console.log('Newton\'s Chromatic MIDI Visualizer loaded');
        console.log('Connect a MIDI device and select it from the dropdown menu');
    </script>
</body>
</html>
