<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newton MIDI Visualizer - Multi-Track</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const NewtonColorPiano = () => {
          const [hoveredKey, setHoveredKey] = useState(null);
          const [showInfo, setShowInfo] = useState(false);
          const [showGuide, setShowGuide] = useState(false);
          const [activeNotes, setActiveNotes] = useState(new Map());
          const [midiAccess, setMidiAccess] = useState(null);
          const [midiConnected, setMidiConnected] = useState(false);
          const [noteHistory, setNoteHistory] = useState([]);
          const [midiDevices, setMidiDevices] = useState([]);
          const [debugInfo, setDebugInfo] = useState('');
          const historyRef = useRef([]);
          
          const newtonBaseColors = {
            'C': { r: 148, g: 0, b: 211, name: 'Violet' },
            'C#': { r: 204, g: 0, b: 102, name: 'Violet-Red' },
            'D': { r: 255, g: 0, b: 0, name: 'Red' },
            'D#': { r: 255, g: 69, b: 0, name: 'Red-Orange' },
            'E': { r: 255, g: 140, b: 0, name: 'Orange' },
            'F': { r: 255, g: 255, b: 0, name: 'Yellow' },
            'F#': { r: 127, g: 255, b: 0, name: 'Yellow-Green' },
            'G': { r: 0, g: 255, b: 0, name: 'Green' },
            'G#': { r: 0, g: 128, b: 255, name: 'Green-Blue' },
            'A': { r: 0, g: 0, b: 255, name: 'Blue' },
            'A#': { r: 75, g: 0, b: 130, name: 'Indigo' },
            'B': { r: 139, g: 0, b: 255, name: 'Indigo-Violet' }
          };

          // Visual styles for different tracks
          const trackStyles = [
            { blur: 4, opacity: 1.0, trail: 1.0, name: 'Track 1' },
            { blur: 6, opacity: 0.85, trail: 0.9, name: 'Track 2' },
            { blur: 8, opacity: 0.75, trail: 0.8, name: 'Track 3' },
            { blur: 10, opacity: 0.65, trail: 0.7, name: 'Track 4' },
            { blur: 12, opacity: 0.60, trail: 0.6, name: 'Track 5' },
            { blur: 14, opacity: 0.55, trail: 0.5, name: 'Track 6' }
          ];

          const getColorForOctave = (baseColor, octave, velocity = 127) => {
            const brightness = octave / 10;
            const saturation = velocity / 127;
            
            const r = Math.round(baseColor.r * brightness * saturation + 255 * (1 - saturation) * brightness);
            const g = Math.round(baseColor.g * brightness * saturation + 255 * (1 - saturation) * brightness);
            const b = Math.round(baseColor.b * brightness * saturation + 255 * (1 - saturation) * brightness);
            
            return `rgb(${r}, ${g}, ${b})`;
          };

          const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
          const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
          const blackNotes = ['C#', 'D#', 'F#', 'G#', 'A#'];
          
          const getNoteFromMidi = (midiNumber, velocity = 127, trackIndex = 0) => {
            const octave = Math.floor(midiNumber / 12) - 1;
            const noteIndex = midiNumber % 12;
            const baseNote = notes[noteIndex];
            const baseColor = newtonBaseColors[baseNote];
            return {
              note: `${baseNote}${octave}`,
              baseNote,
              octave,
              isBlack: blackNotes.includes(baseNote),
              color: getColorForOctave(baseColor, octave, velocity),
              colorName: baseColor.name,
              midiNumber,
              velocity,
              trackIndex
            };
          };

          useEffect(() => {
            if (navigator.requestMIDIAccess) {
              navigator.requestMIDIAccess({ sysex: false })
                .then(access => {
                  setMidiAccess(access);
                  
                  const inputs = Array.from(access.inputs.values());
                  const devices = inputs.map((input, idx) => ({
                    id: input.id,
                    name: input.name,
                    manufacturer: input.manufacturer,
                    trackIndex: idx
                  }));
                  
                  setMidiDevices(devices);
                  setDebugInfo(`Found ${inputs.length} MIDI input(s)`);
                  
                  if (inputs.length > 0) {
                    setMidiConnected(true);
                    inputs.forEach((input, idx) => {
                      console.log(`Connecting Track ${idx + 1}:`, input.name);
                      input.onmidimessage = (message) => handleMIDIMessage(message, idx);
                    });
                  } else {
                    setMidiConnected(false);
                    setDebugInfo('No MIDI devices found. Please connect devices and refresh.');
                  }

                  access.onstatechange = (e) => {
                    const input = e.port;
                    if (input.type === 'input') {
                      const newInputs = Array.from(access.inputs.values());
                      const newDevices = newInputs.map((inp, idx) => ({
                        id: inp.id,
                        name: inp.name,
                        manufacturer: inp.manufacturer,
                        trackIndex: idx
                      }));
                      
                      if (input.state === 'connected') {
                        console.log('MIDI device connected:', input.name);
                        const trackIdx = newInputs.indexOf(input);
                        input.onmidimessage = (message) => handleMIDIMessage(message, trackIdx);
                        setDebugInfo(`Connected: ${input.name}`);
                      } else if (input.state === 'disconnected') {
                        console.log('MIDI device disconnected:', input.name);
                        setDebugInfo('Device disconnected');
                      }
                      
                      setMidiDevices(newDevices);
                      setMidiConnected(newInputs.length > 0);
                    }
                  };
                })
                .catch(err => {
                  console.error('MIDI access failed:', err);
                  setMidiConnected(false);
                  setDebugInfo(`MIDI Error: ${err.message}`);
                });
            } else {
              setDebugInfo('Web MIDI API not supported in this browser');
            }
          }, []);

          const handleMIDIMessage = (message, trackIndex) => {
            const [command, note, velocity] = message.data;
            
            console.log(`Track ${trackIndex + 1} MIDI:`, { command, note, velocity });
            
            const isNoteOn = command >= 144 && command <= 159 && velocity > 0;
            const isNoteOff = (command >= 128 && command <= 143) || (command >= 144 && command <= 159 && velocity === 0);
            
            // Create unique key combining note and track
            const noteKey = `${note}-${trackIndex}`;
            
            if (isNoteOn) {
              setActiveNotes(prev => new Map([...prev, [noteKey, { velocity, trackIndex, note }]]));
              
              const noteData = getNoteFromMidi(note, velocity, trackIndex);
              const historyItem = {
                ...noteData,
                timestamp: Date.now(),
                velocity,
                trackIndex,
                id: Math.random()
              };
              
              historyRef.current = [historyItem, ...historyRef.current].slice(0, 100);
              setNoteHistory([...historyRef.current]);
              
            } else if (isNoteOff) {
              setActiveNotes(prev => {
                const newMap = new Map(prev);
                newMap.delete(noteKey);
                return newMap;
              });
            }
          };

          const generateKeys = () => {
            const keys = [];
            for (let octave = 0; octave <= 10; octave++) {
              for (let i = 0; i < notes.length; i++) {
                if (octave === 10 && i > 0) break;
                const note = notes[i];
                const noteName = `${note}${octave}`;
                const baseColor = newtonBaseColors[note];
                const midiNumber = (octave + 1) * 12 + i;
                
                // Check if this note is active on ANY track
                let maxVelocity = 127;
                let isActive = false;
                activeNotes.forEach((value, key) => {
                  if (value.note === midiNumber) {
                    isActive = true;
                    maxVelocity = Math.max(maxVelocity, value.velocity);
                  }
                });
                
                keys.push({
                  note: noteName,
                  baseNote: note,
                  octave,
                  isBlack: blackNotes.includes(note),
                  color: getColorForOctave(baseColor, octave, maxVelocity),
                  colorName: baseColor.name,
                  midiNumber,
                  isActive,
                  velocity: maxVelocity
                });
              }
            }
            return keys;
          };

          const allKeys = generateKeys();
          const whiteKeys = allKeys.filter(k => !k.isBlack);

          useEffect(() => {
            const interval = setInterval(() => {
              const now = Date.now();
              historyRef.current = historyRef.current.filter(item => now - item.timestamp < 3000);
              setNoteHistory([...historyRef.current]);
            }, 100);
            
            return () => clearInterval(interval);
          }, []);

          return (
            <div className="w-full h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black p-4 overflow-hidden flex flex-col">
              <div className="mb-3 text-center">
                <h1 className="text-3xl font-bold text-white mb-2">Newton MIDI Visualizer - Multi-Track</h1>
                <div className="flex items-center justify-center gap-4 text-sm mb-2">
                  <div className={`flex items-center gap-2 px-3 py-1 rounded-lg ${midiConnected ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200'}`}>
                    <span>{midiConnected ? `âœ“ ${midiDevices.length} Track(s)` : 'âœ— MIDI Disconnected'}</span>
                  </div>
                  <button
                    onClick={() => setShowGuide(!showGuide)}
                    className="inline-flex items-center gap-2 px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors"
                  >
                    ðŸŽ¹ {showGuide ? 'Hide' : 'Show'} Guide
                  </button>
                  <button
                    onClick={() => setShowInfo(!showInfo)}
                    className="inline-flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
                  >
                    â„¹ {showInfo ? 'Hide' : 'Show'} Tracks
                  </button>
                </div>
                {debugInfo && (
                  <div className="text-xs text-yellow-400 mb-1">{debugInfo}</div>
                )}
              </div>

              {showInfo && midiDevices.length > 0 && (
                <div className="bg-gray-800 rounded-lg p-3 mb-3 text-white text-xs max-w-4xl mx-auto">
                  <h3 className="font-bold mb-2">Connected Tracks</h3>
                  <div className="grid grid-cols-2 gap-2">
                    {midiDevices.map((device, idx) => (
                      <div key={device.id} className="flex items-center gap-2 bg-gray-700 rounded p-2">
                        <div 
                          className="w-3 h-3 rounded-full"
                          style={{ opacity: trackStyles[idx]?.opacity || 0.5 }}
                        >
                          <div className="w-full h-full bg-white rounded-full" style={{ filter: `blur(${trackStyles[idx]?.blur || 4}px)` }}></div>
                        </div>
                        <div>
                          <div className="font-bold">Track {idx + 1}</div>
                          <div className="text-gray-400">{device.name}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <p className="text-gray-400 mt-2">Each track has its own visual layer with unique blur and opacity</p>
                </div>
              )}

              {showGuide && (
                <div className="bg-gray-800 rounded-lg p-6 mb-3 text-white max-w-3xl mx-auto">
                  <h3 className="font-bold text-lg mb-4 text-center">Multi-Track Guide</h3>
                  
                  <div className="mb-4">
                    <h4 className="font-semibold mb-2 text-sm">Layer System</h4>
                    <div className="flex items-center justify-center gap-4 mb-2">
                      {trackStyles.slice(0, 4).map((style, idx) => (
                        <div key={idx} className="text-center">
                          <div 
                            className="w-16 h-16 rounded-full bg-red-500 mx-auto mb-1"
                            style={{ 
                              filter: `blur(${style.blur}px)`,
                              opacity: style.opacity
                            }}
                          />
                          <div className="text-xs">{style.name}</div>
                          <div className="text-xs text-gray-400">Blur: {style.blur}px</div>
                        </div>
                      ))}
                    </div>
                    <p className="text-xs text-gray-400 text-center">Track 1 = sharpest/front â€¢ Higher tracks = softer/back</p>
                  </div>

                  <div className="mt-4 p-3 bg-gray-700 rounded">
                    <p className="text-sm mb-2"><strong>Setup in Logic Pro:</strong></p>
                    <ol className="text-xs space-y-1 list-decimal list-inside">
                      <li>Open Audio MIDI Setup â†’ Create multiple IAC buses</li>
                      <li>Route each Logic track to a different IAC bus</li>
                      <li>All tracks visualize simultaneously in layers</li>
                    </ol>
                  </div>
                </div>
              )}

              <div className="flex-1 relative overflow-hidden mb-3">
                <div className="absolute inset-0">
                  {noteHistory.map(item => {
                    const age = Date.now() - item.timestamp;
                    const progress = age / 3000;
                    const yPos = progress * 100;
                    const opacity = (1 - progress) * (trackStyles[item.trackIndex]?.opacity || 0.5);
                    
                    const size = 20 + (item.velocity / 127) * 60;
                    const style = trackStyles[item.trackIndex] || trackStyles[0];
                    
                    return (
                      <div
                        key={item.id}
                        className="absolute rounded-full"
                        style={{
                          left: `${(item.midiNumber / 127) * 100}%`,
                          top: `${yPos}%`,
                          width: `${size}px`,
                          height: `${size}px`,
                          backgroundColor: item.color,
                          opacity: opacity,
                          transform: 'translate(-50%, -50%)',
                          boxShadow: `0 0 ${size / 2}px ${item.color}`,
                          filter: `blur(${style.blur}px)`,
                          transition: 'top 0.1s linear',
                          zIndex: 100 - item.trackIndex
                        }}
                      />
                    );
                  })}
                </div>
              </div>

              <div className="mb-2">
                <div className="text-center text-xs text-gray-400 mb-1">Newton Color Map</div>
                <div className="overflow-x-auto overflow-y-hidden" style={{ height: '160px' }}>
                  <div className="relative h-full" style={{ minWidth: '2900px', paddingLeft: '32px', paddingRight: '32px' }}>
                    <div className="flex h-full items-end">
                      {whiteKeys.map((key) => (
                        <div
                          key={key.note}
                          className={`relative border-r border-gray-700 cursor-pointer transition-all ${
                            key.isActive ? 'brightness-150 scale-105' : 'hover:brightness-110'
                          }`}
                          style={{
                            width: '24px',
                            height: '140px',
                            backgroundColor: key.color,
                            boxShadow: key.isActive 
                              ? `0 0 20px ${key.color}, 0 4px 6px rgba(0,0,0,0.3)` 
                              : '0 4px 6px rgba(0,0,0,0.3)',
                            borderRadius: '0 0 4px 4px',
                            zIndex: key.isActive ? 10 : 1
                          }}
                          onMouseEnter={() => setHoveredKey(key)}
                          onMouseLeave={() => setHoveredKey(null)}
                        >
                          {key.baseNote === 'C' && (
                            <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-xs font-bold text-white bg-black bg-opacity-50 px-1 rounded">
                              {key.octave}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>

                    <div className="absolute top-0 left-0 right-0 flex items-start" style={{ paddingLeft: '32px' }}>
                      {allKeys.map((key, idx) => {
                        if (!key.isBlack) return null;
                        
                        const whiteKeysBefore = allKeys
                          .slice(0, idx)
                          .filter(k => !k.isBlack).length;
                        
                        const offset = 17;
                        
                        return (
                          <div
                            key={key.note}
                            className={`absolute cursor-pointer transition-all ${
                              key.isActive ? 'brightness-150 scale-110' : 'hover:brightness-110'
                            }`}
                            style={{
                              left: `${whiteKeysBefore * 24 + offset}px`,
                              width: '14px',
                              height: '85px',
                              backgroundColor: key.color,
                              boxShadow: key.isActive 
                                ? `0 0 20px ${key.color}, 0 4px 8px rgba(0,0,0,0.5)` 
                                : '0 4px 8px rgba(0,0,0,0.5)',
                              borderRadius: '0 0 3px 3px',
                              border: '1px solid rgba(0,0,0,0.3)',
                              zIndex: key.isActive ? 20 : 5
                            }}
                            onMouseEnter={() => setHoveredKey(key)}
                            onMouseLeave={() => setHoveredKey(null)}
                          />
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <div className="text-center text-xs text-gray-400 mb-1">Traditional Piano</div>
                <div className="overflow-x-auto overflow-y-hidden" style={{ height: '160px' }}>
                  <div className="relative h-full" style={{ minWidth: '2900px', paddingLeft: '32px', paddingRight: '32px' }}>
                    <div className="flex h-full items-end">
                      {whiteKeys.map((key) => (
                        <div
                          key={`mono-${key.note}`}
                          className={`relative border-r border-gray-400 cursor-pointer transition-all ${
                            key.isActive ? 'bg-gray-300' : 'bg-white hover:bg-gray-100'
                          }`}
                          style={{
                            width: '24px',
                            height: '140px',
                            boxShadow: key.isActive 
                              ? '0 0 10px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.2)' 
                              : '0 2px 4px rgba(0,0,0,0.2)',
                            borderRadius: '0 0 4px 4px',
                            zIndex: key.isActive ? 10 : 1
                          }}
                        >
                          {key.baseNote === 'C' && (
                            <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-xs font-bold text-gray-600">
                              {key.octave}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>

                    <div className="absolute top-0 left-0 right-0 flex items-start" style={{ paddingLeft: '32px' }}>
                      {allKeys.map((key, idx) => {
                        if (!key.isBlack) return null;
                        
                        const whiteKeysBefore = allKeys
                          .slice(0, idx)
                          .filter(k => !k.isBlack).length;
                        
                        const offset = 17;
                        
                        return (
                          <div
                            key={`mono-${key.note}`}
                            className={`absolute cursor-pointer transition-all ${
                              key.isActive ? 'bg-gray-600' : 'bg-black hover:bg-gray-800'
                            }`}
                            style={{
                              left: `${whiteKeysBefore * 24 + offset}px`,
                              width: '14px',
                              height: '85px',
                              boxShadow: key.isActive 
                                ? '0 0 10px rgba(255,255,255,0.5), 0 4px 8px rgba(0,0,0,0.8)' 
                                : '0 4px 8px rgba(0,0,0,0.8)',
                              borderRadius: '0 0 3px 3px',
                              border: '1px solid rgba(0,0,0,0.5)',
                              zIndex: key.isActive ? 20 : 5
                            }}
                          />
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>

              <div className="text-center text-gray-400 text-xs mt-2">
                {hoveredKey ? (
                  <span className="text-white font-bold">{hoveredKey.note} ({hoveredKey.colorName}) â€¢ Velocity: {hoveredKey.velocity}</span>
                ) : (
                  `Multi-track MIDI visualizer â€¢ ${midiDevices.length} track(s) connected â€¢ Each track has unique visual layer`
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<NewtonColorPiano />, document.getElementById('root'));
    </script>
</body>
</html>