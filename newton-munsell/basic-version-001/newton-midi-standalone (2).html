<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newton MIDI Visualizer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const NewtonColorPiano = () => {
          const [hoveredKey, setHoveredKey] = useState(null);
          const [showInfo, setShowInfo] = useState(false);
          const [showGuide, setShowGuide] = useState(false);
          const [activeNotes, setActiveNotes] = useState(new Map());
          const [midiAccess, setMidiAccess] = useState(null);
          const [midiConnected, setMidiConnected] = useState(false);
          const [noteHistory, setNoteHistory] = useState([]);
          const [midiDevices, setMidiDevices] = useState([]);
          const [debugInfo, setDebugInfo] = useState('');
          const historyRef = useRef([]);
          
          const newtonBaseColors = {
            'C': { r: 148, g: 0, b: 211, name: 'Violet' },
            'C#': { r: 204, g: 0, b: 102, name: 'Violet-Red' },
            'D': { r: 255, g: 0, b: 0, name: 'Red' },
            'D#': { r: 255, g: 69, b: 0, name: 'Red-Orange' },
            'E': { r: 255, g: 140, b: 0, name: 'Orange' },
            'F': { r: 255, g: 255, b: 0, name: 'Yellow' },
            'F#': { r: 127, g: 255, b: 0, name: 'Yellow-Green' },
            'G': { r: 0, g: 255, b: 0, name: 'Green' },
            'G#': { r: 0, g: 128, b: 255, name: 'Green-Blue' },
            'A': { r: 0, g: 0, b: 255, name: 'Blue' },
            'A#': { r: 75, g: 0, b: 130, name: 'Indigo' },
            'B': { r: 139, g: 0, b: 255, name: 'Indigo-Violet' }
          };

          const getColorForOctave = (baseColor, octave, velocity = 127) => {
            const brightness = octave / 10;
            // Velocity affects saturation (0-127 MIDI range)
            const saturation = velocity / 127;
            
            // Mix base color with white based on saturation
            const r = Math.round(baseColor.r * brightness * saturation + 255 * (1 - saturation) * brightness);
            const g = Math.round(baseColor.g * brightness * saturation + 255 * (1 - saturation) * brightness);
            const b = Math.round(baseColor.b * brightness * saturation + 255 * (1 - saturation) * brightness);
            
            return `rgb(${r}, ${g}, ${b})`;
          };

          const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
          const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
          const blackNotes = ['C#', 'D#', 'F#', 'G#', 'A#'];
          
          const midiToNote = (midiNumber) => {
            const octave = Math.floor(midiNumber / 12) - 1;
            const noteIndex = midiNumber % 12;
            return `${notes[noteIndex]}${octave}`;
          };

          const getNoteFromMidi = (midiNumber, velocity = 127) => {
            const octave = Math.floor(midiNumber / 12) - 1;
            const noteIndex = midiNumber % 12;
            const baseNote = notes[noteIndex];
            const baseColor = newtonBaseColors[baseNote];
            return {
              note: `${baseNote}${octave}`,
              baseNote,
              octave,
              isBlack: blackNotes.includes(baseNote),
              color: getColorForOctave(baseColor, octave, velocity),
              colorName: baseColor.name,
              midiNumber,
              velocity
            };
          };

          useEffect(() => {
            if (navigator.requestMIDIAccess) {
              navigator.requestMIDIAccess({ sysex: false })
                .then(access => {
                  setMidiAccess(access);
                  
                  const inputs = Array.from(access.inputs.values());
                  const devices = inputs.map(input => ({
                    id: input.id,
                    name: input.name,
                    manufacturer: input.manufacturer
                  }));
                  
                  setMidiDevices(devices);
                  setDebugInfo(`Found ${inputs.length} MIDI device(s)`);
                  
                  if (inputs.length > 0) {
                    setMidiConnected(true);
                    inputs.forEach(input => {
                      console.log('Connecting to:', input.name);
                      input.onmidimessage = handleMIDIMessage;
                    });
                  } else {
                    setMidiConnected(false);
                    setDebugInfo('No MIDI devices found. Please connect a device and refresh.');
                  }

                  access.onstatechange = (e) => {
                    const input = e.port;
                    if (input.type === 'input') {
                      if (input.state === 'connected') {
                        console.log('MIDI device connected:', input.name);
                        input.onmidimessage = handleMIDIMessage;
                        setMidiConnected(true);
                        setDebugInfo(`Connected: ${input.name}`);
                      } else if (input.state === 'disconnected') {
                        console.log('MIDI device disconnected:', input.name);
                        setDebugInfo('Device disconnected');
                      }
                      
                      const newInputs = Array.from(access.inputs.values());
                      const newDevices = newInputs.map(inp => ({
                        id: inp.id,
                        name: inp.name,
                        manufacturer: inp.manufacturer
                      }));
                      setMidiDevices(newDevices);
                      setMidiConnected(newInputs.length > 0);
                    }
                  };
                })
                .catch(err => {
                  console.error('MIDI access failed:', err);
                  setMidiConnected(false);
                  setDebugInfo(`MIDI Error: ${err.message}`);
                });
            } else {
              setDebugInfo('Web MIDI API not supported in this browser');
            }
          }, []);

          const handleMIDIMessage = (message) => {
            const [command, note, velocity] = message.data;
            
            console.log('MIDI received:', { command, note, velocity });
            
            const isNoteOn = command >= 144 && command <= 159 && velocity > 0;
            const isNoteOff = (command >= 128 && command <= 143) || (command >= 144 && command <= 159 && velocity === 0);
            
            if (isNoteOn) {
              setActiveNotes(prev => new Map([...prev, [note, velocity]]));
              
              const noteData = getNoteFromMidi(note, velocity);
              const historyItem = {
                ...noteData,
                timestamp: Date.now(),
                velocity,
                id: Math.random()
              };
              
              historyRef.current = [historyItem, ...historyRef.current].slice(0, 50);
              setNoteHistory([...historyRef.current]);
              
            } else if (isNoteOff) {
              setActiveNotes(prev => {
                const newMap = new Map(prev);
                newMap.delete(note);
                return newMap;
              });
            }
          };

          const generateKeys = () => {
            const keys = [];
            for (let octave = 0; octave <= 10; octave++) {
              for (let i = 0; i < notes.length; i++) {
                if (octave === 10 && i > 0) break;
                const note = notes[i];
                const noteName = `${note}${octave}`;
                const baseColor = newtonBaseColors[note];
                const midiNumber = (octave + 1) * 12 + i;
                const velocity = activeNotes.get(midiNumber) || 127;
                keys.push({
                  note: noteName,
                  baseNote: note,
                  octave,
                  isBlack: blackNotes.includes(note),
                  color: getColorForOctave(baseColor, octave, velocity),
                  colorName: baseColor.name,
                  midiNumber,
                  isActive: activeNotes.has(midiNumber),
                  velocity
                });
              }
            }
            return keys;
          };

          const allKeys = generateKeys();
          const whiteKeys = allKeys.filter(k => !k.isBlack);

          useEffect(() => {
            const interval = setInterval(() => {
              const now = Date.now();
              historyRef.current = historyRef.current.filter(item => now - item.timestamp < 3000);
              setNoteHistory([...historyRef.current]);
            }, 100);
            
            return () => clearInterval(interval);
          }, []);

          return (
            <div className="w-full h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black p-4 overflow-hidden flex flex-col">
              <div className="mb-3 text-center">
                <h1 className="text-3xl font-bold text-white mb-2">Newton MIDI Visualizer</h1>
                <div className="flex items-center justify-center gap-4 text-sm mb-2">
                  <div className={`flex items-center gap-2 px-3 py-1 rounded-lg ${midiConnected ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200'}`}>
                    <span>{midiConnected ? `âœ“ MIDI: ${midiDevices.length} device(s)` : 'âœ— MIDI Disconnected'}</span>
                  </div>
                  <button
                    onClick={() => setShowGuide(!showGuide)}
                    className="inline-flex items-center gap-2 px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors"
                  >
                    ðŸŽ¹ {showGuide ? 'Hide' : 'Show'} Guide
                  </button>
                  <button
                    onClick={() => setShowInfo(!showInfo)}
                    className="inline-flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
                  >
                    â„¹ {showInfo ? 'Hide' : 'Show'} Info
                  </button>
                </div>
                {debugInfo && (
                  <div className="text-xs text-yellow-400 mb-1">{debugInfo}</div>
                )}
                {midiDevices.length > 0 && (
                  <div className="text-xs text-gray-400">
                    Connected: {midiDevices.map(d => d.name).join(', ')}
                  </div>
                )}
              </div>

              {showGuide && (
                <div className="bg-gray-800 rounded-lg p-6 mb-3 text-white max-w-3xl mx-auto">
                  <h3 className="font-bold text-lg mb-4 text-center">How It Works</h3>
                  
                  {/* Octave Brightness */}
                  <div className="mb-6">
                    <h4 className="font-semibold mb-3 text-sm">1. Octave â†’ Brightness (C0 to C10)</h4>
                    <div className="flex items-center justify-between gap-2">
                      <span className="text-xs text-gray-400">Low</span>
                      <div className="flex-1 flex gap-1">
                        {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(oct => {
                          const brightness = oct / 10;
                          const r = Math.round(255 * brightness);
                          const g = Math.round(0 * brightness);
                          const b = Math.round(0 * brightness);
                          return (
                            <div key={oct} className="flex-1 text-center">
                              <div 
                                className="w-full h-12 rounded mb-1"
                                style={{ backgroundColor: `rgb(${r}, ${g}, ${b})` }}
                              />
                              <div className="text-xs font-mono">C{oct}</div>
                            </div>
                          );
                        })}
                      </div>
                      <span className="text-xs text-gray-400">High</span>
                    </div>
                    <p className="text-xs text-gray-400 mt-2 text-center">Lower octaves = darker â€¢ Higher octaves = brighter</p>
                  </div>

                  {/* Velocity Saturation */}
                  <div className="mb-6">
                    <h4 className="font-semibold mb-3 text-sm">2. Velocity â†’ Saturation & Size</h4>
                    <div className="flex items-center justify-between gap-2">
                      <span className="text-xs text-gray-400">Soft</span>
                      <div className="flex-1 flex gap-1 items-center justify-center" style={{ height: '80px' }}>
                        {[32, 64, 96, 127].map(vel => {
                          const saturation = vel / 127;
                          const brightness = 0.7; // Mid octave for demo
                          const r = Math.round(255 * brightness * saturation + 255 * (1 - saturation) * brightness);
                          const g = Math.round(0 * brightness * saturation + 255 * (1 - saturation) * brightness);
                          const b = Math.round(0 * brightness * saturation + 255 * (1 - saturation) * brightness);
                          const size = 20 + (vel / 127) * 40;
                          return (
                            <div key={vel} className="flex-1 flex flex-col items-center justify-end gap-1">
                              <div 
                                className="rounded-full"
                                style={{ 
                                  backgroundColor: `rgb(${r}, ${g}, ${b})`,
                                  width: `${size}px`,
                                  height: `${size}px`,
                                  boxShadow: `0 0 ${size/3}px rgb(${r}, ${g}, ${b})`
                                }}
                              />
                              <div className="text-xs font-mono mt-1">{vel}</div>
                            </div>
                          );
                        })}
                      </div>
                      <span className="text-xs text-gray-400">Hard</span>
                    </div>
                    <p className="text-xs text-gray-400 mt-2 text-center">Soft playing = small, pastel â€¢ Hard playing = large, vivid</p>
                  </div>

                  {/* Newton's Color Wheel */}
                  <div>
                    <h4 className="font-semibold mb-3 text-sm">3. Note â†’ Color (Newton's Wheel)</h4>
                    <div className="grid grid-cols-7 gap-2">
                      {whiteNotes.map(note => {
                        const baseColor = newtonBaseColors[note];
                        return (
                          <div key={note} className="text-center">
                            <div 
                              className="w-full h-10 rounded mb-1"
                              style={{ backgroundColor: `rgb(${baseColor.r}, ${baseColor.g}, ${baseColor.b})` }}
                            />
                            <div className="font-bold text-sm">{note}</div>
                            <div className="text-xs text-gray-400">{baseColor.name}</div>
                          </div>
                        );
                      })}
                    </div>
                    <p className="text-xs text-gray-400 mt-3 text-center">Each note has its own color that repeats across all octaves</p>
                  </div>

                  <div className="mt-6 p-3 bg-gray-700 rounded text-center">
                    <p className="text-sm">ðŸŽµ <strong>Try it:</strong> Play soft and hard, low and high notes to see the effects!</p>
                  </div>
                </div>
              )}

              {showInfo && (
                <div className="bg-gray-800 rounded-lg p-3 mb-3 text-white text-xs max-w-4xl mx-auto">
                  <h3 className="font-bold mb-2">Newton's Color Mapping â€¢ C0-C10 â€¢ MIDI Enabled</h3>
                  <p className="mb-2">Connect a MIDI device to visualize notes in real-time.</p>
                  <div className="grid grid-cols-7 gap-2">
                    {whiteNotes.map(note => (
                      <div key={note} className="text-center">
                        <div 
                          className="w-full h-6 rounded mb-1"
                          style={{ backgroundColor: `rgb(${newtonBaseColors[note].r}, ${newtonBaseColors[note].g}, ${newtonBaseColors[note].b})` }}
                        />
                        <div className="font-bold text-xs">{note}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="flex-1 relative overflow-hidden mb-3">
                <div className="absolute inset-0">
                  {noteHistory.map(item => {
                    const age = Date.now() - item.timestamp;
                    const progress = age / 3000;
                    const yPos = progress * 100;
                    const opacity = 1 - progress;
                    
                    // Size based on velocity (20-80px range)
                    const size = 20 + (item.velocity / 127) * 60;
                    
                    return (
                      <div
                        key={item.id}
                        className="absolute rounded-full"
                        style={{
                          left: `${(item.midiNumber / 127) * 100}%`,
                          top: `${yPos}%`,
                          width: `${size}px`,
                          height: `${size}px`,
                          backgroundColor: item.color,
                          opacity: opacity,
                          transform: 'translate(-50%, -50%)',
                          boxShadow: `0 0 ${size / 2}px ${item.color}`,
                          filter: 'blur(4px)',
                          transition: 'top 0.1s linear'
                        }}
                      />
                    );
                  })}
                </div>
              </div>

              {/* Colored Newton Piano */}
              <div className="mb-2">
                <div className="text-center text-xs text-gray-400 mb-1">Newton Color Map</div>
                <div className="overflow-x-auto overflow-y-hidden" style={{ height: '160px' }}>
                  <div className="relative h-full" style={{ minWidth: '2900px', paddingLeft: '32px', paddingRight: '32px' }}>
                    <div className="flex h-full items-end">
                      {whiteKeys.map((key) => (
                        <div
                          key={key.note}
                          className={`relative border-r border-gray-700 cursor-pointer transition-all ${
                            key.isActive ? 'brightness-150 scale-105' : 'hover:brightness-110'
                          }`}
                          style={{
                            width: '24px',
                            height: '140px',
                            backgroundColor: key.color,
                            boxShadow: key.isActive 
                              ? `0 0 20px ${key.color}, 0 4px 6px rgba(0,0,0,0.3)` 
                              : '0 4px 6px rgba(0,0,0,0.3)',
                            borderRadius: '0 0 4px 4px',
                            zIndex: key.isActive ? 10 : 1
                          }}
                          onMouseEnter={() => setHoveredKey(key)}
                          onMouseLeave={() => setHoveredKey(null)}
                        >
                          {key.baseNote === 'C' && (
                            <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-xs font-bold text-white bg-black bg-opacity-50 px-1 rounded">
                              {key.octave}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>

                    <div className="absolute top-0 left-0 right-0 flex items-start" style={{ paddingLeft: '32px' }}>
                      {allKeys.map((key, idx) => {
                        if (!key.isBlack) return null;
                        
                        const whiteKeysBefore = allKeys
                          .slice(0, idx)
                          .filter(k => !k.isBlack).length;
                        
                        const offset = 17;
                        
                        return (
                          <div
                            key={key.note}
                            className={`absolute cursor-pointer transition-all ${
                              key.isActive ? 'brightness-150 scale-110' : 'hover:brightness-110'
                            }`}
                            style={{
                              left: `${whiteKeysBefore * 24 + offset}px`,
                              width: '14px',
                              height: '85px',
                              backgroundColor: key.color,
                              boxShadow: key.isActive 
                                ? `0 0 20px ${key.color}, 0 4px 8px rgba(0,0,0,0.5)` 
                                : '0 4px 8px rgba(0,0,0,0.5)',
                              borderRadius: '0 0 3px 3px',
                              border: '1px solid rgba(0,0,0,0.3)',
                              zIndex: key.isActive ? 20 : 5
                            }}
                            onMouseEnter={() => setHoveredKey(key)}
                            onMouseLeave={() => setHoveredKey(null)}
                          />
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>

              {/* Monochrome Piano */}
              <div>
                <div className="text-center text-xs text-gray-400 mb-1">Traditional Piano</div>
                <div className="overflow-x-auto overflow-y-hidden" style={{ height: '160px' }}>
                  <div className="relative h-full" style={{ minWidth: '2900px', paddingLeft: '32px', paddingRight: '32px' }}>
                    <div className="flex h-full items-end">
                      {whiteKeys.map((key) => (
                        <div
                          key={`mono-${key.note}`}
                          className={`relative border-r border-gray-400 cursor-pointer transition-all ${
                            key.isActive ? 'bg-gray-300' : 'bg-white hover:bg-gray-100'
                          }`}
                          style={{
                            width: '24px',
                            height: '140px',
                            boxShadow: key.isActive 
                              ? '0 0 10px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.2)' 
                              : '0 2px 4px rgba(0,0,0,0.2)',
                            borderRadius: '0 0 4px 4px',
                            zIndex: key.isActive ? 10 : 1
                          }}
                        >
                          {key.baseNote === 'C' && (
                            <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-xs font-bold text-gray-600">
                              {key.octave}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>

                    <div className="absolute top-0 left-0 right-0 flex items-start" style={{ paddingLeft: '32px' }}>
                      {allKeys.map((key, idx) => {
                        if (!key.isBlack) return null;
                        
                        const whiteKeysBefore = allKeys
                          .slice(0, idx)
                          .filter(k => !k.isBlack).length;
                        
                        const offset = 17;
                        
                        return (
                          <div
                            key={`mono-${key.note}`}
                            className={`absolute cursor-pointer transition-all ${
                              key.isActive ? 'bg-gray-600' : 'bg-black hover:bg-gray-800'
                            }`}
                            style={{
                              left: `${whiteKeysBefore * 24 + offset}px`,
                              width: '14px',
                              height: '85px',
                              boxShadow: key.isActive 
                                ? '0 0 10px rgba(255,255,255,0.5), 0 4px 8px rgba(0,0,0,0.8)' 
                                : '0 4px 8px rgba(0,0,0,0.8)',
                              borderRadius: '0 0 3px 3px',
                              border: '1px solid rgba(0,0,0,0.5)',
                              zIndex: key.isActive ? 20 : 5
                            }}
                          />
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>

              <div className="text-center text-gray-400 text-xs mt-2">
                {hoveredKey ? (
                  <span className="text-white font-bold">{hoveredKey.note} ({hoveredKey.colorName}) â€¢ Velocity: {hoveredKey.velocity}</span>
                ) : (
                  'Play MIDI to visualize â€¢ Velocity affects circle size and color saturation â€¢ Newton color wheel C0-C10'
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<NewtonColorPiano />, document.getElementById('root'));
    </script>
</body>
</html>